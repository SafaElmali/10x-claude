#!/bin/bash

# work-tickets - Process multiple Linear tickets in parallel
# Usage: work-tickets WEB-5503 WEB-5563 WEB-5905
#
# Each ticket gets:
# - Its own git worktree at ~/Desktop/swarm-{ticket-id}
# - A dedicated Warp terminal tab
# - Claude Code running with /analyze-linear-ticket
# - Automatic PR creation via /create-pr when complete

REPO_DIR="$HOME/Desktop/swarm"
WORKTREE_BASE="$HOME/Desktop/swarm"
USE_RALPH=false
MAX_ITERATIONS=""
TERMINAL=""

# Detect available terminal
detect_terminal() {
  if [ -n "$TERMINAL" ]; then
    echo "$TERMINAL"
  elif [ -d "/Applications/Warp.app" ]; then
    echo "warp"
  elif [ -d "/Applications/iTerm.app" ]; then
    echo "iterm"
  else
    echo "terminal"
  fi
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_usage() {
  echo -e "${BLUE}Usage:${NC} work-tickets [OPTIONS] <TICKET-ID> [TICKET-ID...]"
  echo ""
  echo -e "${BLUE}Examples:${NC}"
  echo "  work-tickets WEB-5503"
  echo "  work-tickets WEB-5503 WEB-5563 WEB-5905"
  echo "  work-tickets --ralph WEB-5503           # Use Ralph workflow"
  echo "  work-tickets --ralph --iterations 30 WEB-5503"
  echo "  work-tickets --terminal iterm WEB-5503  # Use iTerm2"
  echo ""
  echo -e "${BLUE}Options:${NC}"
  echo "  -h, --help           Show this help message"
  echo "  --cleanup            Remove all ticket worktrees"
  echo "  --list               List existing ticket worktrees"
  echo "  --ralph              Use Ralph Loop workflow (iterative development)"
  echo "  --iterations <n>     Max iterations for Ralph (default: auto based on task size)"
  echo "  --terminal <name>    Terminal to use: warp, iterm, terminal (auto-detected if not set)"
}

cleanup_worktrees() {
  echo -e "${YELLOW}Cleaning up ticket worktrees...${NC}"
  cd "$REPO_DIR" || exit 1
  for dir in "$WORKTREE_BASE"/swarm-WEB-*; do
    if [ -d "$dir" ]; then
      ticket=$(basename "$dir" | sed 's/swarm-//')
      echo -e "  Removing ${BLUE}$ticket${NC}..."
      git worktree remove "$dir" --force 2>/dev/null
    fi
  done
  echo -e "${GREEN}âœ“ Cleanup complete${NC}"
}

list_worktrees() {
  echo -e "${BLUE}Existing ticket worktrees:${NC}"
  found=false
  for dir in "$WORKTREE_BASE"/swarm-WEB-*; do
    if [ -d "$dir" ]; then
      found=true
      ticket=$(basename "$dir" | sed 's/swarm-//')
      branch=$(cd "$dir" && git branch --show-current 2>/dev/null)
      echo -e "  ${GREEN}$ticket${NC} â†’ $dir (branch: $branch)"
    fi
  done
  if [ "$found" = false ]; then
    echo "  No ticket worktrees found."
  fi
}

# Parse arguments
if [ $# -eq 0 ]; then
  print_usage
  exit 1
fi

TICKETS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      print_usage
      exit 0
      ;;
    --cleanup)
      cleanup_worktrees
      exit 0
      ;;
    --list)
      list_worktrees
      exit 0
      ;;
    --ralph)
      USE_RALPH=true
      shift
      ;;
    --iterations)
      MAX_ITERATIONS="$2"
      shift 2
      ;;
    --terminal)
      TERMINAL="$2"
      shift 2
      ;;
    *)
      TICKETS+=("$1")
      shift
      ;;
  esac
done

# Detect terminal after parsing args
DETECTED_TERMINAL=$(detect_terminal)

# Check if we have tickets to process
if [ ${#TICKETS[@]} -eq 0 ]; then
  echo -e "${RED}Error:${NC} No ticket IDs provided"
  print_usage
  exit 1
fi

# Verify repo exists
if [ ! -d "$REPO_DIR/.git" ]; then
  echo -e "${RED}Error:${NC} Repository not found at $REPO_DIR"
  exit 1
fi

# Show detected terminal
echo -e "${BLUE}Using terminal:${NC} $DETECTED_TERMINAL"

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
if [ "$USE_RALPH" = true ]; then
  echo -e "${BLUE}â•‘${NC}    ğŸ”„ Starting Ralph Workflow Processing     ${BLUE}â•‘${NC}"
else
  echo -e "${BLUE}â•‘${NC}       ğŸš€ Starting Ticket Processing         ${BLUE}â•‘${NC}"
fi
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Process each ticket
for TICKET_ID in "${TICKETS[@]}"; do
  WORKTREE_DIR="$WORKTREE_BASE/swarm-$TICKET_ID"
  # Get branch name from Linear ticket format (lowercase)
  BRANCH_NAME="safa/$(echo "$TICKET_ID" | tr '[:upper:]' '[:lower:]')"

  echo -e "${YELLOW}Processing ${BLUE}$TICKET_ID${NC}..."

  # Fetch latest from origin first
  cd "$REPO_DIR" || exit 1
  git fetch origin main --quiet

  # Create worktree if it doesn't exist
  if [ ! -d "$WORKTREE_DIR" ]; then
    # Try to create new branch from origin/main
    if git worktree add "$WORKTREE_DIR" -b "$BRANCH_NAME" origin/main 2>/dev/null; then
      echo -e "  ${GREEN}âœ“${NC} Created new worktree with branch ${BLUE}$BRANCH_NAME${NC}"
    elif git worktree add "$WORKTREE_DIR" "$BRANCH_NAME" 2>/dev/null; then
      echo -e "  ${GREEN}âœ“${NC} Created worktree from existing branch ${BLUE}$BRANCH_NAME${NC}"
    else
      echo -e "  ${RED}âœ—${NC} Failed to create worktree for $TICKET_ID"
      continue
    fi
  else
    echo -e "  ${GREEN}âœ“${NC} Worktree already exists"
  fi

  # Build the Claude command based on workflow mode
  if [ "$USE_RALPH" = true ]; then
    # Ralph workflow: iterative development with progress tracking
    ITERATIONS_ARG=""
    if [ -n "$MAX_ITERATIONS" ]; then
      ITERATIONS_ARG=" --max-iterations $MAX_ITERATIONS"
    fi
    # Keep command simple for AppleScript compatibility
    CLAUDE_COMMAND="/ralph-workflow $TICKET_ID$ITERATIONS_ARG"
  else
    # Standard workflow - simple command
    CLAUDE_COMMAND="/analyze-linear-ticket $TICKET_ID && /review-and-fix && /create-pr"
  fi

  # Build the full terminal command
  TERMINAL_CMD="cd $WORKTREE_DIR && cc '$CLAUDE_COMMAND'"

  # Open split/tab based on terminal type
  case "$DETECTED_TERMINAL" in
    warp)
      # Warp: Cmd+D for vertical split
      osascript -e "tell application \"Warp\" to activate" \
                -e "delay 0.5" \
                -e "tell application \"System Events\" to keystroke \"d\" using command down" \
                -e "delay 1" \
                -e "tell application \"System Events\" to keystroke \"$TERMINAL_CMD\"" \
                -e "delay 0.3" \
                -e "tell application \"System Events\" to keystroke return"
      ;;
    iterm)
      # iTerm2: Cmd+D for vertical split
      osascript -e "tell application \"iTerm\" to activate" \
                -e "delay 0.5" \
                -e "tell application \"System Events\" to keystroke \"d\" using command down" \
                -e "delay 1" \
                -e "tell application \"System Events\" to keystroke \"$TERMINAL_CMD\"" \
                -e "delay 0.3" \
                -e "tell application \"System Events\" to keystroke return"
      ;;
    terminal)
      # macOS Terminal: Cmd+T for new tab (no native split)
      osascript -e "tell application \"Terminal\" to activate" \
                -e "delay 0.5" \
                -e "tell application \"System Events\" to keystroke \"t\" using command down" \
                -e "delay 1" \
                -e "tell application \"System Events\" to keystroke \"$TERMINAL_CMD\"" \
                -e "delay 0.3" \
                -e "tell application \"System Events\" to keystroke return"
      ;;
  esac

  echo -e "  ${GREEN}âœ“${NC} Started Claude agent in split pane"
  sleep 1  # Small delay between panes to prevent race conditions
done

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘${NC}  âœ… All ${#TICKETS[@]} ticket(s) started!               ${GREEN}â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}Worktrees:${NC}"
for TICKET_ID in "${TICKETS[@]}"; do
  echo -e "  â€¢ ${YELLOW}$TICKET_ID${NC} â†’ ~/Desktop/swarm-$TICKET_ID"
done
echo ""
if [ "$USE_RALPH" = true ]; then
  echo -e "${BLUE}Ralph Workflow Mode:${NC}"
  echo "  â€¢ Progress tracked in progress.txt"
  echo "  â€¢ Commits after each feature"
  echo "  â€¢ Delete progress.txt when done"
  echo ""
fi
echo -e "${BLUE}Tips:${NC}"
echo "  â€¢ Check each split pane/tab for Claude's progress"
if [ "$DETECTED_TERMINAL" = "warp" ] || [ "$DETECTED_TERMINAL" = "iterm" ]; then
  echo "  â€¢ Use Cmd+[ and Cmd+] to navigate between panes"
fi
echo "  â€¢ Run 'work-tickets --list' to see all worktrees"
echo "  â€¢ Run 'work-tickets --cleanup' when done"
